import logging
import urllib
import json
import ssl
from urllib import request, parse
from urllib.request import HTTPError, URLError

ip = params["connect_tychonelastic_ip"]
port = params["connect_tychonelastic_port"]
apiKey = params["connect_tychonelastic_api_key"]
index = params["connect_tychonelastic_cve_iava_index"]

#dependencies
mac = params["mac"]
host_name = params["nbthost"]

upper_mac = mac.upper()
colon_mac = ":".join(upper_mac[i:i+2] for i in range(0,12,2))

query = {
    "query": {
        "bool": {
            "filter":[
                {
                    "bool": {
                        "should":{
                            "match":{
                                "vulnerability.result.keyword": "fail"
                            }
                        }
                    }
                },
                {
                    "bool": {
                        "should":{
                            "match_phrase":{
                                "host.mac.keyword": colon_mac
                            }
                        }
                    }
                },
                {
                    "bool": {
                        "should":{
                            "match_phrase":{
                                "host.hostname.keyword": host_name
                            }
                        }
                    }
                }
            ]
        }
    },"_source":[
        "vulnerability.id",
        "vulnerability.iava"
    ]
}

data = json.dumps(query).encode("utf-8")

request = urllib.request.Request(url='https://'+ip+':'+port+'/'+index+'/_search')
request.add_header("accept", "application/json")
request.add_header("Authorization", "ApiKey " + apiKey)
request.add_header("Content-Type", "application/json")
request.method = "GET"
request.data = data

response = {}
properties = {}

vulnerability_list = []
try:
    with urllib.request.urlopen(request, context=ssl_context) as resp:
        resp_bytes = resp.read()
        resp_ascii = resp_bytes.decode(encoding="UTF-8")
        obj = json.loads(resp_ascii)
        if 'hits' in obj:
            if 'hits' in obj['hits']:
                for o in obj['hits']['hits']:
                    if '_source' in o:
                        data = o['_source']
                        composite_entry = {}
                        composite_entry["cveid"] = data["vulnerability.id"]
                        composite_entry["cveiava"] = data["vulnerability.iava"]
                        vulnerability_list.append(composite_entry)


    properties['connect_tychonelastic_vulnerability_failed_listing'] = vulnerability_list
    response["properties"] = properties
    logging.debug("Returning CVE response object to infrastructure. response=[{}]".format(response))
except HTTPError as e:
    response["error"] = "HTTPError: {}".format(e.code)
except URLError as e:
	response["error"] = "URLError: {}".format(e.reason)
except Exception as e:
	response["error"] = "Exception: {}".format(str(e))
